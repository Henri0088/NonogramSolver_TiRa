<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\users\saskeli\documents\visual studio 2015\projects\nonogramsolver\solverlib\treesolver.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Diagnostics;
using GameLib;
using Util;

namespace SolverLib
{
    /// &lt;summary&gt;
    /// Gametree based nonogram solver class. Scales 2^n.
    /// &lt;/summary&gt;
    public class TreeSolver : ISolver
    {
        private bool _solved;
        private TimeSpan _benchTime = TimeSpan.Zero;

        /// &lt;summary&gt;
        /// Attempt to solve the given nonogram
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ng&quot;&gt;Nonogram to solve&lt;/param&gt;
        /// &lt;returns&gt;Number of resolved tiles&lt;/returns&gt;
        public int Run(Nonogram ng)
        {
            _solved = false;
            Stopwatch sw = Stopwatch.StartNew();
            int resolved = Treesolve(ng, 0, 0);
            sw.Stop();
            _benchTime = sw.Elapsed;
            if (resolved == -1) return 0;
            _solved = true;
            return resolved;
        }

        /// &lt;summary&gt;
        /// Recursive gamtree for nonotgrams
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ng&quot;&gt;Nonogram to solve&lt;/param&gt;
        /// &lt;param name=&quot;row&quot;&gt;Row index process&lt;/param&gt;
        /// &lt;param name=&quot;column&quot;&gt;Column index to process&lt;/param&gt;
        /// &lt;returns&gt;Number of resolved tiles. -1 if there was a previous error&lt;/returns&gt;
        private int Treesolve(Nonogram ng, int row, int column)
        {
            int nColumn = column + 1 &lt; ng.Width ? column + 1 : 0;
            int nRow = nColumn == 0 ? row + 1 : row;
            if (!ng.Resolved(row, column))
            {
                ng.Set(row, column, true);
                if (!Error(ng, row, column))
                {
                    int res = nRow &lt; ng.Height ? Treesolve(ng, nRow, nColumn) : 0;
                    if (res &gt;= 0)
                    {
                        return res + 1;
                    }
                }
                ng.Set(row, column, false);
                if (!Error(ng, row, column))
                {
                    int res = nRow &lt; ng.Height ? Treesolve(ng, nRow, nColumn) : 0;
                    if (res &gt;= 0)
                    {
                        return res + 1;
                    }
                }
                ng.Clear(row, column);
                return -1;
            }
            return nRow &lt; ng.Height ? Treesolve(ng, nRow, nColumn) : 0;
        }

        /// &lt;summary&gt;
        /// Checks nonogram for obvious errors related to specified tile.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ng&quot;&gt;Nonogram to check&lt;/param&gt;
        /// &lt;param name=&quot;row&quot;&gt;Row index of tile&lt;/param&gt;
        /// &lt;param name=&quot;column&quot;&gt;Column index of tile&lt;/param&gt;
        /// &lt;returns&gt;True if error was found.&lt;/returns&gt;
        private bool Error(Nonogram ng, int row, int column)
        {
            int lineSum = ng.RowSum(row);
            for (int i = 0; i &lt; ng.Width; i++)
            {
                if (ng.IsTrue(row, i)) lineSum--;
                if (lineSum &lt; 0) return true;
            }
            lineSum = ng.ColumnSum(column);
            for (int i = 0; i &lt; ng.Height; i++)
            {
                if (ng.IsTrue(i, column)) lineSum--;
                if (lineSum &lt; 0) return true;
            }
            if (column == ng.Width - 1)
            {
                int num = 0;
                List&lt;int&gt; nums = new List&lt;int&gt;();
                for (int i = 0; i &lt; ng.Width; i++)
                {
                    if (ng.IsTrue(row, i))
                    {
                        num++;
                    }
                    else
                    {
                        if (num != 0) nums.Add(num);
                        num = 0;
                    }
                }
                if (num != 0) nums.Add(num);
                for (int i = 0; i &lt; nums.Count; i++)
                {
                    if (nums[i] != ng.GetRowNum(row, i)) return true;
                }
                if (ng.GetRowNum(row, nums.Count) != 0) return true;
            }
            if (row == ng.Height - 1)
            {
                int num = 0;
                List&lt;int&gt; nums = new List&lt;int&gt;();
                for (int i = 0; i &lt; ng.Height; i++)
                {
                    if (ng.IsTrue(i, column))
                    {
                        num++;
                    }
                    else 
                    {
                        if (num != 0) nums.Add(num);
                        num = 0;
                    }
                }
                if (num != 0) nums.Add(num);
                for (int i = 0; i &lt; nums.Count; i++)
                {
                    if (nums[i] != ng.GetColumnNum(column, i)) return true;
                }
                if (ng.GetColumnNum(column, nums.Count) != 0) return true;
            }
            return false;
        }

        /// &lt;summary&gt;
        /// Checks wether a nonogram was solved
        /// &lt;/summary&gt;
        /// &lt;returns&gt;True if the solver has been run and the last run resulted in a solved nonogram&lt;/returns&gt;
        public bool Solved()
        {
            return _solved;
        }

        /// &lt;summary&gt;
        /// Time spent on number crunching.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;Timespan representing the time spent on last Run method&lt;/returns&gt;
        public TimeSpan BenchTime()
        {
            return _benchTime;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[28,33,28,42,0],[67,13,67,72,0],[22,9,22,10,1],[23,13,23,29,1],[24,13,24,49,1],[25,13,25,48,1],[26,13,26,23,1],[27,13,27,37,1],[28,13,28,32,1],[29,13,29,28,1],[30,13,30,29,1],[31,9,31,10,1],[41,9,41,10,1],[42,13,42,66,1],[43,13,43,53,1],[44,13,44,43,1],[45,13,45,14,1],[46,17,46,43,1],[47,17,47,45,1],[48,17,48,18,1],[49,21,49,83,1],[50,21,50,34,1],[51,21,51,22,1],[52,25,52,40,1],[54,17,54,18,1],[55,17,55,44,1],[56,17,56,45,1],[57,17,57,18,1],[58,21,58,83,1],[59,21,59,34,1],[60,21,60,22,1],[61,25,61,40,1],[63,17,63,18,1],[64,17,64,39,1],[65,17,65,27,1],[68,9,68,10,1],[78,9,78,10,1],[79,13,79,42,1],[80,18,80,27,1],[81,13,81,14,1],[82,17,82,39,1],[82,40,82,50,1],[83,17,83,33,1],[83,34,83,46,1],[84,13,84,14,1],[80,43,80,46,1],[80,29,80,41,1],[85,13,85,44,1],[86,18,86,27,1],[87,13,87,14,1],[88,17,88,42,1],[88,43,88,53,1],[89,17,89,33,1],[89,34,89,46,1],[90,13,90,14,1],[86,44,86,47,1],[86,29,86,42,1],[91,13,91,40,1],[92,13,92,14,1],[93,17,93,29,1],[94,17,94,50,1],[95,22,95,31,1],[96,17,96,18,1],[97,21,97,43,1],[98,21,98,22,1],[99,25,99,31,1],[100,21,100,22,1],[102,21,102,22,1],[103,25,103,38,1],[103,39,103,53,1],[104,25,104,33,1],[105,21,105,22,1],[106,17,106,18,1],[95,47,95,50,1],[95,33,95,45,1],[107,17,107,30,1],[107,31,107,45,1],[108,22,108,31,1],[109,17,109,18,1],[110,21,110,57,1],[110,58,110,70,1],[111,17,111,18,1],[108,49,108,52,1],[108,33,108,47,1],[112,17,112,56,1],[112,57,112,69,1],[113,13,113,14,1],[114,13,114,38,1],[115,13,115,14,1],[116,17,116,29,1],[117,17,117,50,1],[118,22,118,31,1],[119,17,119,18,1],[120,21,120,46,1],[121,21,121,22,1],[122,25,122,31,1],[123,21,123,22,1],[125,21,125,22,1],[126,25,126,38,1],[126,39,126,53,1],[127,25,127,33,1],[128,21,128,22,1],[129,17,129,18,1],[118,48,118,51,1],[118,33,118,46,1],[130,17,130,30,1],[130,31,130,45,1],[131,22,131,31,1],[132,17,132,18,1],[133,21,133,63,1],[133,64,133,76,1],[134,17,134,18,1],[131,49,131,52,1],[131,33,131,47,1],[135,17,135,62,1],[135,63,135,75,1],[136,13,136,14,1],[137,13,137,26,1],[138,9,138,10,1],[145,9,145,10,1],[146,13,146,28,1],[147,9,147,10,1],[154,9,154,10,1],[155,13,155,31,1],[156,9,156,10,1],[14,9,14,53,1]]);
    </script>
  </body>
</html>